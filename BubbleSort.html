<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Matrix Sort: Protocol v2</title>
    <style>
        :root {
            /* Tông màu xanh trầm hơn để không đau mắt */
            --matrix-green: #008f11; 
            --bright-green: #00FF41;
            --dark-bg: #050a05;
            --font-main: 'Consolas', 'Courier New', monospace;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--matrix-green);
            font-family: var(--font-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* Màn hình chiến thắng */
        #victory-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            border: 2px solid var(--matrix-green);
        }

        .victory-text {
            font-size: 3rem;
            color: var(--bright-green);
            text-shadow: 0 0 20px var(--bright-green);
            margin-bottom: 20px;
            animation: pulse 1.5s infinite;
        }

        #terminal-header {
            width: 80%;
            border-bottom: 1px solid #1a3a1a;
            margin-bottom: 30px;
            padding: 10px;
            font-size: 1rem;
            opacity: 0.8;
        }

        #array-display {
            display: flex;
            gap: 15px;
            margin-bottom: 40px;
        }

        .node {
            width: 65px;
            height: 65px;
            border: 1px solid var(--matrix-green);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            transition: all 0.3s ease;
            background: rgba(0, 20, 0, 0.5);
        }

        .node.comparing {
            border: 2px solid var(--bright-green);
            box-shadow: 0 0 10px var(--bright-green);
            color: var(--bright-green);
        }

        .node.swapping {
            background-color: var(--matrix-green);
            color: #000;
        }

        .node.sorted {
            border-color: #555;
            color: #555;
        }

        #hint-box {
            height: 60px;
            color: #ccc;
            font-size: 0.9rem;
            max-width: 500px;
            text-align: center;
        }

        .btn {
            background: transparent;
            color: var(--matrix-green);
            border: 1px solid var(--matrix-green);
            padding: 12px 25px;
            cursor: pointer;
            font-family: var(--font-main);
            margin: 10px;
            text-transform: uppercase;
            transition: 0.2s;
        }

        .btn:hover {
            background: var(--matrix-green);
            color: #000;
        }

        .stats { margin-top: 20px; font-size: 0.8rem; opacity: 0.6; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
    </style>
</head>
<body>

    <div id="victory-overlay">
        <div class="victory-text">MISSION ACCOMPLISHED</div>
        <p style="color: #ccc;">Dữ liệu đã được sắp xếp hoàn hảo.</p>
        <div id="final-stats" style="margin: 20px 0;"></div>
        <button class="btn" onclick="initGame()">RE-RUN PROTOCOL</button>
    </div>

    <div id="terminal-header">
        > LOG: BUBBLE_SORT_ALGORITHM_INITIATED...<br>
        > STATUS: WAITING FOR USER INPUT
    </div>

    <div id="array-display"></div>
    
    <div id="hint-box">Đang quét bộ nhớ...</div>

    <div>
        <button class="btn" onclick="processStep(true)">SWAP (Đổi chỗ)</button>
        <button class="btn" onclick="processStep(false)">KEEP (Giữ nguyên)</button>
    </div>

    <div class="stats">
        [ Pass: <span id="pass-count">0</span> | Comparison: <span id="comp-count">0</span> ]
    </div>

    <script>
        let array = [];
        let i = 0, j = 0;
        let totalComparisons = 0;
        let isComplete = false;

        function initGame() {
            document.getElementById('victory-overlay').style.display = 'none';
            array = Array.from({length: 5}, () => Math.floor(Math.random() * 89) + 10);
            i = 0; j = 0; totalComparisons = 0;
            isComplete = false;
            updateUI();
            setHint("Nhiệm vụ: Nếu số bên TRÁI lớn hơn số bên PHẢI -> chọn SWAP.");
        }

        function updateUI() {
            const container = document.getElementById('array-display');
            container.innerHTML = '';
            
            array.forEach((val, idx) => {
                const node = document.createElement('div');
                node.className = 'node';
                // Đánh dấu cặp đang so sánh
                if (!isComplete && (idx === j || idx === j + 1)) {
                    node.classList.add('comparing');
                }
                // Đánh dấu các phần tử đã nằm đúng vị trí ở cuối mảng
                if (idx > array.length - 1 - i) {
                    node.classList.add('sorted');
                }
                node.innerText = val;
                container.appendChild(node);
            });

            document.getElementById('pass-count').innerText = i;
            document.getElementById('comp-count').innerText = totalComparisons;
        }

        function setHint(txt, color = "#ccc") {
            const h = document.getElementById('hint-box');
            h.innerText = txt;
            h.style.color = color;
        }

        function processStep(userSwap) {
            if (isComplete) return;

            const shouldSwap = array[j] > array[j+1];
            totalComparisons++;

            if (userSwap === shouldSwap) {
                if (shouldSwap) {
                    const nodes = document.querySelectorAll('.node');
                    nodes[j].classList.add('swapping');
                    nodes[j+1].classList.add('swapping');
                    
                    setTimeout(() => {
                        [array[j], array[j+1]] = [array[j+1], array[j]];
                        advanceLogic();
                    }, 400);
                } else {
                    advanceLogic();
                }
                setHint("Chính xác. Tiếp tục phân tích...", "var(--matrix-green)");
            } else {
                setHint(shouldSwap ? "SAI: Số bên trái lớn hơn, phải SWAP!" : "SAI: Số bên trái nhỏ hơn, nên KEEP!", "#ff4444");
                // Rung nhẹ màn hình khi sai
                document.body.style.transform = "translateX(5px)";
                setTimeout(() => document.body.style.transform = "none", 50);
            }
        }

        function advanceLogic() {
            j++;
            // Kết thúc 1 lượt quét (pass)
            if (j >= array.length - 1 - i) {
                j = 0;
                i++;
            }

            // Kết thúc toàn bộ thuật toán
            if (i >= array.length - 1) {
                isComplete = true;
                showVictory();
            }
            updateUI();
        }

        function showVictory() {
            const overlay = document.getElementById('victory-overlay');
            const stats = document.getElementById('final-stats');
            overlay.style.display = 'flex';
            stats.innerHTML = `Tổng số lần so sánh: ${totalComparisons}<br>Mảng cuối: [ ${array.join(' - ')} ]`;
        }

        function setHint(txt, color = "#ccc") {
            const h = document.getElementById('hint-box');
            h.innerText = txt;
            h.style.color = color;
        }

        window.onload = initGame;
    </script>
</body>
</html>